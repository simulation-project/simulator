<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Module /home/marwa/lib/ms/test/ms_app_SUITE.erl</title>
<meta http-equiv="cache-control" content="no-cache">
<link rel="stylesheet" href="../../ct_default.css" type="text/css"></head>
<body>

<pre>
    1:<i>%%% Copyright (C) 2012 ITI Egypt.</i>
    2:<i>%%%</i>
    3:<i>%%% The contents of this file are subject to the Erlang Public License,</i>
    4:<i>%%% Version 1.1, (the "License"); you may not use this file except in</i>
    5:<i>%%% compliance with the License. You should have received a copy of the</i>
    6:<i>%%% Erlang Public License along with this software. If not, it can be</i>
    7:<i>%%% retrieved via the world wide web at http://www.erlang.org/.</i>
    8:<i>%%%</i>
    9:<i>%%% Software distributed under the License is distributed on an "AS IS"</i>
<a name="10"></a>   10:<i>%%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
   11:<i>%%% the License for the specific language governing rights and limitations</i>
   12:<i>%%% under the License.</i>
   13:<i>%%%</i>
   14:<i>%%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   15:<i>%%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   16:<i>%%% AB. All Rights Reserved.</i>
   17:
   18:<i>%%% @doc </i>
   19:<i>%%%</i>
<a name="20"></a>   20:<i>%%% @copyright 2012 ITI Egypt.</i>
   21:<i>%%% @author Marwa ElShahed &lt;marwa.elshahed@hotmail.com&gt;</i>
   22:<i>%%%         [http://www.iti.gov.eg/]</i>
   23:<i>%%% @end</i>
   24:-<b>module</b>(ms_app_SUITE).
   25:
   26:<i>%%% Include files</i>
   27:-<b>include</b>("ct.hrl").
   28:
   29:<i>%%% External exports</i>
<a name="30"></a>   30:-<b>compile</b>(export_all).
   31:
   32:<i>%%% Macros</i>
   33:-<b>define</b>(MATCH_SPEC, [{'_', [], [{message, {return_trace}}]}]).
   34:-<b>define</b>(MAX_TIME, 10000).
   35:-<b>define</b>(STUBS_DIR, "../../stubs").  % Tests run in log/ct_run.*
   36:
   37:<i>%%%-----------------------------------------------------------------------------</i>
   38:<i>%%% Suite Exports</i>
   39:<i>%%%-----------------------------------------------------------------------------</i>
<a name="40"></a>   40:<i>%% @spec all() -&gt; Result</i>
   41:<i>%%    Result = TestCases | {skip, Reason}</i>
   42:<i>%%    TestCases = [TestCase]</i>
   43:<i>%%    TestCase = atom()</i>
   44:<i>%%    Reason   = term()</i>
   45:<i>%%</i>
   46:<i>%% @doc Returns the list of test cases that are to be executed.</i>
   47:<i>%% @end</i>
<a name=all>   48:<b>all</b></a>() -&gt;
   49:    [api, api_neg, performance].
<a name="50"></a>   50:
   51:<i>%% @spec sequences() -&gt; Sequences</i>
   52:<i>%%    Sequences = [{Name, Cases}]</i>
   53:<i>%%    Name = atom()</i>
   54:<i>%%    Cases = [Case]</i>
   55:<i>%%    Case = atom()</i>
   56:<i>%%</i>
   57:<i>%% @doc Specifies test case sequences.</i>
   58:<i>%% @end</i>
<a name=sequences>   59:<b>sequences</b></a>() -&gt;
<a name="60"></a>   60:    [].
   61:
   62:<i>%% @spec suite() -&gt; Info</i>
   63:<i>%%    Info = [tuple()]</i>
   64:<i>%%</i>
   65:<i>%% @doc Returns a list of tuples to set default properties for the suite.</i>
   66:<i>%% @end</i>
<a name=suite>   67:<b>suite</b></a>() -&gt;
   68:    [{timetrap, {minutes, 60}}].
   69:
<a name="70"></a>   70:<i>%%%-----------------------------------------------------------------------------</i>
   71:<i>%%% Init Suite Exports</i>
   72:<i>%%%-----------------------------------------------------------------------------</i>
   73:<i>%% @spec init_per_suite(Conf) -&gt; Conf</i>
   74:<i>%%     Conf = [tuple()]</i>
   75:<i>%%</i>
   76:<i>%% @doc Initiation before the whole suite.</i>
   77:<i>%%</i>
   78:<i>%% &lt;b&gt;Note:&lt;/b&gt; This function is free to add any key/value pairs to the</i>
   79:<i>%% &lt;u&gt;Conf&lt;/u&gt; variable, but should NOT alter/remove any existing entries.</i>
<a name="80"></a>   80:<i>%% @end</i>
<a name=init_per_suite>   81:<b>init_per_suite</b></a>(Conf) -&gt;
   82:    ok = application:start(sasl),
   83:    ok = application:start(crypto),
   84:    ok = application:start(public_key),
   85:    ok = application:start(ssl), 
   86:    ok = application:start(epgsql),
   87:    ok = application:start(ms),
   88:    lists:foreach(fun(X) -&gt; code:add_path(X) end, ct:get_config(paths, [])),
   89:    {A1, A2, A3} = now(),
<a name="90"></a>   90:    random:seed(A1, A2, A3),
   91:    dbg:tracer(),
   92:    dbg:p(all, [c, sos, sol]),
   93:    MaxTime = ct:get_config(max_time, ?MAX_TIME),
   94:    [{max_time, MaxTime} | Conf].
   95:
   96:<i>%%%-----------------------------------------------------------------------------</i>
   97:<i>%%% End Suite Exports</i>
   98:<i>%%%-----------------------------------------------------------------------------</i>
   99:<i>%% @spec end_per_suite(Conf) -&gt; Result</i>
<a name="100"></a>  100:<i>%%    Conf = [tuple()]</i>
  101:<i>%%    Result = ok | {save_config, Conf1}</i>
  102:<i>%%</i>
  103:<i>%% @doc Cleanup after the suite.</i>
  104:<i>%% @end</i>
<a name=end_per_suite>  105:<b>end_per_suite</b></a>(_Conf) -&gt;
  106:    ok = application:stop(sasl),
  107:    ok = application:stop(crypto),
  108:    ok = application:stop(public_key),
  109:    ok = application:stop(ssl), 
<a name="110"></a>  110:    ok = application:stop(epgsql),
  111:    ok = application:stop(ms).
  112:
  113:<i>%%%-----------------------------------------------------------------------------</i>
  114:<i>%%% Init Case Exports</i>
  115:<i>%%%-----------------------------------------------------------------------------</i>
  116:<i>%% @spec init_per_testcase(Case, Conf) -&gt; Result</i>
  117:<i>%%    Case = atom()</i>
  118:<i>%%    Conf = [tuple()]</i>
  119:<i>%%    Result = NewConf |</i>
<a name="120"></a>  120:<i>%%             {skip, Reason} |</i>
  121:<i>%%             {skip_and_save, Reason, NewConf}</i>
  122:<i>%%    NewConf = [tuple()]</i>
  123:<i>%%    Reason = term()</i>
  124:<i>%%</i>
  125:<i>%% @doc Initialization before each test case.</i>
  126:<i>%% @end</i>
<a name=init_per_testcase>  127:<b>init_per_testcase</b></a>(Case, Conf) -&gt;
  128:    ct:print("Starting test case ~p", [Case]),
  129:    init_stubs(Case),
<a name="130"></a>  130:    init_traces(Case),
  131:    Conf.
  132:
<a name=init_stubs>  133:<b>init_stubs</b></a>(Case) -&gt;
  134:    NegCases = ct:get_config(neg_cases, []),
  135:    Stubs = proplists:get_value(Case, NegCases, []),
  136:    lists:foreach(fun(Stub) -&gt; load_stub(Stub, true) end, Stubs).
  137:
<a name=init_traces>  138:<b>init_traces</b></a>(Case) -&gt;
  139:    TpCases = ct:get_config(tp_cases, []),
<a name="140"></a>  140:    Tps = proplists:get_value(Case, TpCases, []),
  141:    lists:foreach(fun(Tp) -&gt; add_trace(tp, Tp) end, Tps),
  142:    TplCases = ct:get_config(tpl_cases, []),
  143:    Tpls = proplists:get_value(Case, TplCases, []),
  144:    lists:foreach(fun(Tpl) -&gt; add_trace(tp, Tpl) end, Tpls).
  145:
  146:<i>%%%-----------------------------------------------------------------------------</i>
  147:<i>%%% End Case Exports</i>
  148:<i>%%%-----------------------------------------------------------------------------</i>
  149:<i>%% @spec end_per_testcase(Case, Conf) -&gt; Result</i>
<a name="150"></a>  150:<i>%%    Case = atom()</i>
  151:<i>%%    Conf = [tuple()]</i>
  152:<i>%%    Result = NewConf |</i>
  153:<i>%%             {skip, Reason} |</i>
  154:<i>%%             {skip_and_save, Reason, NewConf}</i>
  155:<i>%%    NewConf = [tuple()]</i>
  156:<i>%%    Reason = term()</i>
  157:<i>%%</i>
  158:<i>%% @doc Cleanup after each test case.</i>
  159:<i>%% @end</i>
<a name=end_per_testcase><a name="160"></a>  160:<b>end_per_testcase</b></a>(Case, Conf) -&gt;
  161:    end_traces(Case),
  162:    end_stubs(Case),
  163:    ct:print("Test case ~p completed", [Case]),
  164:    Conf.
  165:
<a name=end_stubs>  166:<b>end_stubs</b></a>(Case) -&gt;
  167:    NegCases = ct:get_config(neg_cases, []),
  168:    Stubs = proplists:get_value(Case, NegCases, []),
  169:    lists:foreach(fun purge_stub/1, Stubs).
<a name="170"></a>  170:
<a name=end_traces>  171:<b>end_traces</b></a>(Case) -&gt;
  172:    TpCases = ct:get_config(tp_cases, []),
  173:    Tps = proplists:get_value(Case, TpCases, []),
  174:    lists:foreach(fun(Tp) -&gt; del_trace(ctp, Tp) end, Tps),
  175:    TplCases = ct:get_config(tpl_cases, []),
  176:    Tpls = proplists:get_value(Case, TplCases, []),
  177:    lists:foreach(fun(Tpl) -&gt; del_trace(ctpl, Tpl) end, Tpls).
  178:
  179:<i>%%%-----------------------------------------------------------------------------</i>
<a name="180"></a>  180:<i>%%% Test Cases</i>
  181:<i>%%%-----------------------------------------------------------------------------</i>
<a name=api>  182:<b>api</b></a>() -&gt;
  183:    [{userdata, [{doc, "Tests the public API."}]}].
  184:
<a name=api>  185:<b>api</b></a>(_Conf) -&gt;
  186:    {ok,_Pid} = ms_app:create_ms({ms1,lai1}),
  187:    ok = ms_fsm:send_event({ms1,turn_on_idle}).
  188:    
<a name=api_neg>  189:<b>api_neg</b></a>() -&gt;
<a name="190"></a>  190:    [{userdata, [{doc, "Tests the public API with invalid input data."}]}].
  191:
<a name=api_neg>  192:<b>api_neg</b></a>(_Conf) -&gt;
  193:    ok.
  194:
  195:
<a name=performance>  196:<b>performance</b></a>() -&gt;
  197:    [{userdata, [{doc, "Test performace restrictions."}]}].
  198:
<a name=performance>  199:<b>performance</b></a>(Conf) -&gt;
<a name="200"></a>  200:    MaxTime = ?config(max_time, Conf),
  201:    {T, _} = timer:tc(?MODULE, performance_test, [Conf]),
  202:    if trunc(T/1000) &gt; MaxTime -&gt; exit(too_slow); true -&gt; ok end.
  203:
<a name=performance_test>  204:<b>performance_test</b></a>(_Conf) -&gt;
  205:    ok.
  206:<i>%%%-----------------------------------------------------------------------------</i>
  207:<i>%%% Tracing Util Functions</i>
  208:<i>%%%-----------------------------------------------------------------------------</i>
<a name=add_trace>  209:<b>add_trace</b></a>(TpFun, {Mod, Fun, Spec}) -&gt;
<a name="210"></a>  210:    dbg:TpFun(Mod, Fun, Spec);
<a name=add_trace>  211:<b>add_trace</b></a>(TpFun, {Mod, Fun}) -&gt;
  212:    dbg:TpFun(Mod, Fun, ?MATCH_SPEC);
<a name=add_trace>  213:<b>add_trace</b></a>(TpFun, Mod) -&gt;
  214:    dbg:TpFun(Mod, ?MATCH_SPEC).
  215:
  216:
<a name=del_trace>  217:<b>del_trace</b></a>(CtpFun, {Mod, Fun, _Spec}) -&gt;
  218:    dbg:CtpFun(Mod, Fun);
<a name=del_trace>  219:<b>del_trace</b></a>(CtpFun, {Mod, Fun}) -&gt;
<a name="220"></a>  220:    dbg:CtpFun(Mod, Fun);
<a name=del_trace>  221:<b>del_trace</b></a>(CtpFun, Mod) -&gt;
  222:    dbg:CtpFun(Mod).
  223:
  224:<i>%%%-----------------------------------------------------------------------------</i>
  225:<i>%%% Stub Util Functions</i>
  226:<i>%%%-----------------------------------------------------------------------------</i>
<a name=load_stub>  227:<b>load_stub</b></a>(Stub, NegTest) -&gt;
  228:    Opts = if NegTest -&gt; [binary, {d, neg_case}]; true -&gt;  [binary] end,
  229:    Erl = atom_to_list(Stub) ++ ".erl",
<a name="230"></a>  230:    ct:print("Compiling ~s with options ~p", [Erl, Opts]),
  231:    {ok, Mod, Bin} = compile:file(filename:join(?STUBS_DIR, Erl), Opts),
  232:    ct:print("Purge default ~p stub", [Mod]),
  233:    code:purge(Mod),
  234:    code:delete(Mod),
  235:    ct:print("Loading new ~p stub", [Mod]),
  236:    Beam = atom_to_list(Mod) ++ code:objfile_extension(),
  237:    {module, Mod} = code:load_binary(Mod, Beam, Bin).
  238:
  239:
<a name=purge_stub><a name="240"></a>  240:<b>purge_stub</b></a>(Stub) -&gt;
  241:    ct:print("Purge ~p stub", [Stub]),
  242:    code:purge(Stub),
  243:    code:delete(Stub),
  244:    ct:print("Reloading default ~p stub", [Stub]),
  245:    {module, Stub} = code:load_file(Stub).
</pre>
</body>
</html>
